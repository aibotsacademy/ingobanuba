<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Banuba SDK Web AR demo</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.6/dist/semantic.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.6/dist/semantic.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="ui container">

<div id="webar"></div>
    <script type="module">
      import { Webcam, Effect, Player, Dom } from "./BanubaSDK.js"

      const run = async () => {
        const player = await Player.create({ clientToken: "Nf4EMUI+HI72LLAymjPGxzRKfEC8pkAjGbiOTzWJ9W6krx/u+kEqMSryG72ST6w/suEfPljuKbEdAmPNCSbyXaIkioqXLqSfOudmV+7GlDgR1pQsd3K1z3D7hl+P1/OKDEHkL5AT7NhDhQ+AGmxODHO43gdMRb0A0pq9j8mB6i11fGgpWjqgZ1OFNUHeBIwmB7EuIfk+7dTAaYa2ihWGO1Noc0z5DKi+FQLomiab7BO4T+B1mJzuOtZBtpoPs3PtgCw5uPhejf7GlPtm6JCksbl82B5GgURSsaWt7YBAnRgXemjK9a54f69O/jvrjZ8aSlDaS7Hh7mwV1OaGGj38JvFXmZTK01xUVnJcmn7o2FVeRhpelUS3i1JKnr4mCEADG90YgSn5xS7Rr9qddBEaML0jyZeeSYDpJxd4r7RATP0oi0dQygfRkPPzbUZ3AO6OdQOJ4axOANfsMrQrmVJJq9K+8X574e6jxnYldqNpjzW36AxLT2Lneiw7jbFK5BVNGjRqG5Fs4V+5J47+iHPKQe7FXR5lYhoNYNRABzS5KFjsC+fr9ESkhi3A3kbw4EFICaZtuXua1QTFffnEG2gImStiNMxddcutey9dX7QrhrXWcTU7xKNgS/B04y2wJ0sqOTLE+bANDCLEpOUb0Eoy5IO3lYl0ymBmd7AQp8xO5oUaJkY3T1AxTwFEen30JlLwf6WFWI6C2LINS5s/A9FODppVDYmWO+ATjjpCILAyEHkBzOvMd+HtRh5pu2FF6hYmHLdlXLkQrlHFWnjGhcaeeh0pj9ZtnnrP6Za1GrEn3apA8o6OkiCTqN+FEi+TvMgWM8S6NuQ3BOrCfC+sMoMIqw+K9i9G1woxE0NVRu4RtU1VQjwMYI1yiDiw29Yg/154BVHwPhd/ltcGcu3srQBpeE9q1btFskTvEwLrNRBc2SlzPJZ8MqxmEhoOoezHcla1hVgP74OR+rQjlOT9nhUtAWpj1HsJF8qB8uW+7UQ5otF11sjL3rB0TAis2vunzKIpWBE2Bz2AWSwVKmOrBr1/P9Qj49cx0dF7+TIL9tkSsdwPya2WjAQ/bd9IYGMFCuL1F6Ra29rtsUKp05LMbF15MaITnSAGwQSM1zFGIG1oyfoHEkjnl14aphQlzRNFDCewLt5VRlJgdonWu5mwm0CjRTIxHcbGukoY+SStxeIQ3hVAlUhQ6Ukq+LX+kCcAYfWD/sXAU6YQyTYuiNjo6/HouNFIeOyB8FmU58GuUaU6o7b6VgJ1ES1JWmtpb96XuRAmIoRZlogf/eJsC+kAUB3QH/UC96/vOqHaCl5YFsrAWB4Ex6MlDZqwsULkXizDmCXOqQHCBInz3Z2bY6N092DzU/ZHKaRNHbS2b4DXDsjOI3X/mk6RGrPea7bxZYzxsJg7lPo+zClE05n+rmDR2c0wdPgHM+LOKvQ5dEEKNyHWSp29lybmkp68Xr97d6+Q2EskPoRRAc78NbjoQWzpg7nhIIfpJ1H07kauoNNMWThaqubESm9dgHueD0Xy7rN6mW5xM9mLK9Tx7LLoffQGkMSmzRdT25Lt9N0Fm67vbSDam0dT2QICwCbYjhNrH7aDVKCv4oUTsacF1TA8MQBCZzuLlwtvueUHs+ZdBGGdjrAWbLUE9rH+2LSLk9EjyfWv3x7hrsu0/U53Cko+1Y0WTIhn/R6qUW7UIELf0x/Xkgzeom470No9Cp1hXuRPCUrksdJ1Leo=" })

        player.use(new Webcam())

        player.applyEffect(new Effect("Spider.zip"))

        Dom.render(player, "#webar")
      }

      run()
    </script>
    <header>
      <h2>Select an effect:</h2>
      <label class="ui sub header">
        FPS lock
        <select class="ui dropdown">
          <option value="30" selected>30</option>
          <option value="60">60</option>
          <option value="-1">ðŸ”¥ Unlocked ðŸ”¥</option>
        </select>
      </label>
      <button class="ui button" id="reset">Reset</button>
      <div id="effects"></div>
    </header>

    <main>
      <span id="rec" hidden>
        <i class="circle icon"></i>
        REC
      </span>
      <span id="fps">
        Webcam FPS: <span id="cam"></span>
        </br>
        Processing FPS: <span id="processing"></span>
        </br>
        Render FPS: <span id="render"></span>
      </span>
      <div id="webar"></div>
      <button class="ui icon button" id="sound">
        <i class="volume icon"></i>
      </button>
    </main>

    <footer>
      <button class="ui right labeled icon button" id="screenshot">
        <i class="file image icon"></i>
        Screenshot
      </button>

      <div class="ui buttons">
        <button class="ui right labeled icon button" data-content="Start video recording" id="start">
          <i class="play icon"></i>
          Video recording
        </button>
        <button class="ui icon button" data-content="Pause video recording" id="pause">
          <i class="pause icon"></i>
        </button>
        <button class="ui icon button" data-content="Resume video recording" id="resume">
          <i class="step forward icon"></i>
        </button>
        <button class="ui icon button" data-content="Stop video recording" id="stop">
          <i class="stop icon"></i>
        </button>
      </div>
    </footer>

    <script src="BanubaClientToken.js"></script>
    <script type="module">
      import { Effect, Webcam, Player, VideoRecorder, ImageCapture, Dom } from "./BanubaSDK.js"

      const effects = [
        "Afro",
        "PoliceMan",
        "Glasses",
        "MonsterFactory",
        "Spider",
      ]

      ;(async () => {
        const wcam = new Webcam()
        const player = await Player.create({
          clientToken: window.BANUBA_CLIENT_TOKEN
        })

        player.use(new Webcam())

        $('select').dropdown({ onChange: (fps) => player.use(wcam, { fps }) })

        Dom.render(player, "#webar")

        //#region fps
        const fps = {
          cam: 0,
          processing: 0,
          render: 0,
        }
        player.addEventListener("framereceived", () => fps.cam++)
        player.addEventListener("frameprocessed", ({ detail }) => fps.processing = 1. / detail.averagedDuration)
        player.addEventListener("framerendered", () => fps.render++)

        setInterval(() => {
          Object
                  .entries(fps)
                  .forEach(([name, value]) => {
                    fps[name] = 0
                    $(`#${name}`).text(value.toFixed(1))
                  })
        }, 1000)
        //#endregion

        //#region effects
        $.each(effects, async (idx, effectName) => {
          const btn = $(
            `<button class="ui primary button elastic loading">
              ${effectName}
            </button>`
          )
          .prependTo("#effects")

          const effect = await Effect.preload(`effects/${effectName}.zip`)

          btn.on("click", () => player.applyEffect(effect))
          btn.removeClass("loading")
        })
        $("#reset").on("click", () => player.clearEffect())
        //#endregion

        //#region volume
        let volume = 0 // initial volume state (muted by default)

        $("#sound > i").toggleClass(volume ? "up" : "mute")
        $("#sound").on("click", () => player.setVolume(volume = +!volume)) // toggle 0 - 1

        player.addEventListener("volumechange", () => $("#sound > i").toggleClass("up mute"))
        //#endregion

        //#region image capture
        const capture = new ImageCapture(player)

        $("#screenshot").on("click", async () => $("body").toast({
          title: "Screenshot is ready",
          message: `Check the <a href="${URL.createObjectURL(await capture.takePhoto())}" target="_blank">link</a>`,
          class: { toast: "ui info message" },
        }))
        //#endregion

        //#region video recording
        let recorder

        // lazy recorder initialization cuz it eats fps :(
        const getRecorder = () => {
          if (recorder) return recorder

          recorder = new VideoRecorder(player)

          recorder.addEventListener("start", () => $("#rec").show())
          recorder.addEventListener("pause", () => $("#rec").hide())
          recorder.addEventListener("resume", () => $("#rec").show())
          recorder.addEventListener("stop", () => $("#rec").hide())

          return recorder
        }

        $("#start").on("click", () => getRecorder().start())
        $("#pause").on("click", () => getRecorder().pause())
        $("#resume").on("click", () => getRecorder().resume())
        $("#stop").on("click", async () => $("body").toast({
          title: "Video record is ready",
          message: `Check the <a href="${URL.createObjectURL(await getRecorder().stop())}" target="_blank">link</a>`,
          class: { toast: "ui info message" },
        }))

        //#endregion
      })()
    </script>
</body>

</html>
